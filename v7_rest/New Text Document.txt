import getSessionId from '@salesforce/apex/SessionController.getSessionId';

export default class MsgUploader extends LightningElement {
    sessionId;

    connectedCallback() {
        getSessionId()
            .then(id => { this.sessionId = id; })
            .catch(e => { console.error('Failed to get session', e); });
    }
    // ... rest of your code
}


/////////////////////////////////////////////////////////
async uploadFileMultipart({ fileName, mimeType, binaryArrayBuffer, firstPublishLocationId }) {
    const baseUrl = window.location.origin;
    const url = `${baseUrl}/services/data/v60.0/sobjects/ContentVersion`;

    const form = new FormData();

    // Part 1: JSON entity metadata
    const entity = {
        Title: fileName,
        PathOnClient: fileName,
        FirstPublishLocationId: firstPublishLocationId
    };
    form.append(
        "entity_content",
        new Blob([JSON.stringify(entity)], { type: "application/json" })
    );

    // Part 2: Binary file
    form.append(
        "VersionData",
        new Blob([binaryArrayBuffer], { type: mimeType || "application/octet-stream" }),
        fileName
    );

    const resp = await fetch(url, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + this.sessionId
            // ‚ùó DO NOT set Content-Type. Browser sets the correct boundary.
        },
        body: form
    });

    if (!resp.ok) {
        throw new Error(`Upload failed (${resp.status}): ${await resp.text()}`);
    }
    return resp.json();
}


/**
 * Link a ContentDocument to another record (EmailMessage, Case, etc.).
 * Pass the ContentDocumentId returned by /ContentVersion (or by refetch).
 */
async createContentDocumentLink({ contentDocumentId, linkedEntityId }) {
    const baseUrl = window.location.origin;
    const url = `${baseUrl}/services/data/v60.0/sobjects/ContentDocumentLink`;

    const resp = await fetch(url, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + this.sessionId,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            ContentDocumentId: contentDocumentId,
            LinkedEntityId: linkedEntityId,
            ShareType: 'V' // Viewer; use 'I' for Inferred, 'C' for Collaborator
        })
    });

    if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`CDL failed (${resp.status}): ${text}`);
    }
    return resp.json();
}

/////////////////

// 1) Upload the original .MSG file (use the same File you read earlier)
const msgFile = this.template.querySelector('lightning-input[type="file"]').files[0];
const msgBuffer = await msgFile.arrayBuffer();

const msgUploadResult = await this.uploadFileMultipart({
    fileName: msgFile.name,
    mimeType: msgFile.type || 'application/vnd.ms-outlook', // safe fallback
    binaryArrayBuffer: msgBuffer,
    firstPublishLocationId: emailId // link directly to the EmailMessage
});

// If you need the ContentDocumentId:

const msgContentDocumentId = msgUploadResult.ContentDocumentId || msgUploadResult.contentDocumentId;

////////////////
Upload failed (400): <html> <head> <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1"/> <title>Error 400 Buffer size exceeded: no line terminator</title> </head> <body><h2>HTTP ERROR 400 Buffer size exceeded: no line terminator</h2> <table> <tr><th>URI:</th><td>/services/data/v60.0/sobjects/ContentVersion</td></tr> <tr><th>STATUS:</th><td>400</td></tr> <tr><th>MESSAGE:</th><td>Buffer size exceeded: no line terminator</td></tr> <tr><th>SERVLET:</th><td>SfdcRestServlet-X</td></tr> </table> </body> </html>

